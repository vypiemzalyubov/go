# Домашнее задание

## Подготовка:

Скопировать в проект заготовки:
- `.gitlab-ci.yml`
- `.golangci.yml`
- `.pre-commit-config.yaml`
- `.protolint.yaml`

## Основное задание:

- Повторить действия из урока
  - Реализовать джобы
    - `build`
    - `unit`
    - `linter`
    - `pre-commit`
    - `create image`
    - `http test`
    - `grpc test`

## Критерии приемки задания:
- Есть pipeline с джобами: 
  - В стейдже `build` находятся джобы
    - `build`
    - `unit`
    - `linter`
    - `pre-commit`
  - В стейдже `publish` находятся джобы
    - `create image`
  - В стейдже `e2e` находятся джобы
    - `http test`
    - `grpc test`
  - Джобы `ready to prod` и `close release` должны быть с ручным запуском
  - pipeline запускается по пушу в ветку
  - Все джобы в pipeline зеленые
  - Джобы выполняют свою полезную работу
    - `build` - сборка бинарника нашего сервиса
    - `unit` - прогон Unit-тестов + сохранение в артефакты репорта в junit формате
    - `linter` - прогон линтера
    - `pre-commit` - прогон pre-commit-хуков
    - `create image` - собирает образ с приложением и пушит его в gitlab-registry
      - взять из мастера в [репозитории сервиса wallet](https://gitlab.ozon.dev/qa/classroom-14/students/service/wallet/-/blob/master/.gitlab-ci.yml#L80)
    - `http test` - прогон HTTP-тестов + сохранение в артефакты репорта в junit формате
      - e2e тесты лежат в этой репе в директории `test`. Перенесите в свой проект. Не забудьте сделать `go mod tidy`
    - `grpc test` - прогон gRPC-тестов + сохранение в артефакты репорта в junit формате
      - e2e тесты лежат в этой репе в директории `test`. Перенесите в свой проект. Не забудьте сделать `go mod tidy`

  Пример pipeline, запускаемый по push в Gitlab
  ![default pipeline](images/default.png)

## Дополнительные задания:
### 1. Запускать джобы, связанные с продом, в отдельном pipeline
  Если вы обратите внимание, то заметите, что в pipeline есть джобы, связанные с продом
  - `release image` - "создание" образа для прода 
  - `production` - "деплой" образа на прод
  - `production latest` - "смена" дефолтного роута на новую версию сервиса
  - `close release` - "закрытие" релиза

  Эти джобы должны появляться только в том случае, когда нам надо раскатить наш релиз на проде
  
  Необходимо поправить `rules` таким образом, чтобы:
  - При пуше в ветку запускались все джобы, кроме указанных с продом (указаны выше)
  - Вышеуказанные джобы запускались только в pipeline, запущенном через `COMMIT_TAG`

  ### Критерии приемки задания:
  - Есть pipeline для обычных веток.
    - В нем отсутствуют вышеуказанные джобы

  Пример pipeline, запускаемый по push в Gitlab
  !["Production pipeline"](images/production_app_pipe.png)

  - Есть pipeline, запущенный `COMMIT_TAG`-ом
    - В нем только вышеуказанные джобы
    - Джобы `production latest` и `close release` должны быть с ручным запуском 
  
  Пример pipeline, запускаемый по COMMIT_TAG
  !["Production pipeline"](images/production_pipe.png)

  #### Для проставления тега можно использовать команды
  ```shell
  git tag release/0.0.1       
  git push --tags origin 
  ```
### 2. Заменить `production latest` на `canary`-джобы
  Задание - продолжение предыдущего

  Вместо смены дефолтного роута для всех пользователей необходимо реализовать джобы для канареечного релиза
  
  Необходимо поправить конфигурацию следующим образом:
  - Добавить новый stage `canary` перед стейджом  `close`
  - Заменить `production latest` на несколько `canary`-джоб
    - canary 0%
    - canary 1%
    - canary 5%
    - canary 10%
    - canary 20%
    - canary 50%
    - canary 100%
  ### Критерии приемки задания:
  - Есть pipeline для обычных веток.
    - В нем отсутствуют вышеуказанные джобы

  Пример pipeline, запускаемый по push в Gitlab
  !["Production pipeline"](images/production_app_pipe.png)

  - Есть pipeline, запущенный `COMMIT_TAG`-ом
    - В этом pipeline вместо `production latest` несколько `canary`-джоб
    - Все `canary`-джобы нахоятся в стедже `canary`
    - Есть шаблон `.canary`, который наследуют все `canary`-джобы
      - В шаблоне должны быть прописаны
        - правила запуска 
        - переменная `CANARY`, через которую передается % для вывода сообщения
    - При запуске `canary`-джоб должно выводиться сообщение
      - echo "Canary 0/10/50/100%"
        - проценты должны соответствовать процентам в названии джобы

  Пример pipeline, запускаемый по COMMIT_TAG
  !["Canary pipeline"](images/canary_pipe.png)

  ### Дедлайны сдачи и проверки задания:
- 5 октября 23:59 (сдача) / 8 октября, 23:59 (проверка)
